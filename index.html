<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OCORR√äNCIAS - EQUIPE ECHO</title>
  <style>

    *{box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}

    html,body{height:100%;
      background:#0b1020;
      color:white;
      overflow:hidden}

    .wrap{display:flex;
        flex-direction:row;
        align-items:stretch;
        justify-content:space-between;
        height:100vh;
        width:100vw;
        padding:20px;
        gap:20px}

    .editor{
        flex:1;
        max-width:420px;
        padding:20px;
        background:rgba(255,255,255,0.04);
        border-radius:12px;
        box-shadow:0 6px 18px rgba(3,6,15,0.6);
        display:flex;
        flex-direction:column;
        justify-content:flex-start;
        overflow-y: auto;
        }

    h1{font-size:20px;
        margin-bottom:10px;
        text-align:center}

    label{display:block;
      font-size:13px;
      margin-top:12px;
      color:white}

    input[type=text]{width:100%;
      padding:12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.06);
      background:rgba(255,255,255,0.02);
      color:inherit;
      font-size:16px;
      margin-top:4px}

    .btn{display:inline-block;
      margin-top:14px;
      padding:10px 14px;
      border-radius:10px;
      border:none;background:#1f6feb;
      color:white;
      font-weight:600;
      cursor:pointer}

    .btn.secondary{background:#2a2f44}

    .btn-group{margin-top:20px;
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap}

    .siglas{display:flex;
      gap:10px;
      margin-top:6px;
      flex-wrap:wrap}

    .siglas label{font-size:14px;
      display:flex;
      align-items:center;
      gap:5px}

    .telao{flex:3;
      display:flex;
      align-items:center;
      justify-content:center;
      height:100%;}

    .display-area{width:600px;
      height:800px;
      background:linear-gradient(180deg,#071026,#0b1226);
      border-radius:14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding:0px 0px;
      box-shadow:0 10px 30px rgba(2,6,15,0.7)}

    .card{width:100%;
      height:100%;
      border-radius:12px;
      padding:30px;          
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      justify-content:flex-start;
      gap:30px;
      transition:all 240ms ease;
      margin-top: 0px;
      }

    .batalhao{width:95%;
      text-align:center;
      font-size:55px;
      font-weight:800; 
      margin-top:-20px;}

    .batalhao {
        position: relative;
    }

    .tipo{width:100%;
      text-align:left;
      font-size:40px;
      font-weight:700}
      
    .local{width:100%;
      text-align:left;
      font-size:30px;
      font-weight:600}

    textarea {
      width: 100%;
     padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.02);
      color: inherit;
      font-size: 16px;
      margin-top: 4px;
      resize: vertical; 
      min-height: 80px;
    } 


    /*.status-green{background:linear-gradient(180deg,#0f5b27,#1bb158);color:white} */
    .status-green{background-color: inherit;}
    .status-yellow{background:linear-gradient(180deg,#8a6b00,#ffd166);color:white}
    .status-red{background:linear-gradient(180deg,#7b0d0d,#ff6b6b);color:white}

    @keyframes pulse-soft{
      0%{filter:brightness(1);}
      50%{filter:brightness(1.06);}
      100%{filter:brightness(1);}
    }
    @keyframes blink-slow{
      0%{opacity:1}
      50%{opacity:0.82}
      100%{opacity:1}
    }

    @keyframes flash-reset {
    0% { filter: brightness(1.6); }
    100% { filter: brightness(1); }
    }

    .flash {
    animation: flash-reset 0.5s ease-in-out;
    }

    .pulse{
      animation:pulse-soft 1.6s ease-in-out infinite
    }
    
    .blink{
      animation:blink-slow 1s linear infinite
    }

    .assinatura{
      margin-top:auto;
      text-align:center;
      font-size:12px;
      color:rgba(255,255,255,0.6);
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,0.08);
    }

    @media(max-width:900px){
      .wrap{flex-direction:column}
      .editor{max-width:100%;}
      .batalhao{font-size:60px}
      .tipo{font-size:36px}
      .local{font-size:26px}
    }
  </style>

</head>

<body>
    
  <div class="wrap">
    <div class="editor">
      <h1>Bloco de Notas ‚Äî Editor</h1>

      <label for="numBatalhao">BATALH√ÉO</label>
      <input id="numBatalhao" type="text" placeholder="Batalh√£o com dois digitos. Ex.: 00" maxlength="2" />
      <div class="siglas" id="siglasBatalhao">
        <label><input type="radio" name="sigla" value="BPM/M"> BPM/M</label>
        <label><input type="radio" name="sigla" value="BAEP"> BAEP</label>
        <label><input type="radio" name="sigla" value="BPTRAN"> BPTRAN</label>
        <label><input type="radio" name="sigla" value="BPRV"> BPRV</label>
      </div>

      <label for="tipo">QRU</label>
      <input id="tipo" type="text" placeholder="Ex.: Acompanhamento / Pinote / Averigua√ß√£o" />

      <label for="local">QTH</label>
      <textarea id="local" rows="8" placeholder="Ex.: Av. Paulista x R. Augusta"></textarea>

      <div class="btn-group">
        <button id="btnUpdate" class="btn">Atualizar Manualmente</button>
        <button id="reset" class="btn secondary">Limpar</button>
        <button id="btnSetaEsq" class="btn secondary">‚Üê Esquerda</button>
        <button id="btnSetaDir" class="btn secondary">Direita ‚Üí</button>
      </div>
      <div class="assinatura">
        Desenvolvido por <strong>SD PM HENRIQUE BARROS</strong> ‚Äî VDM EQUIPE ECHO
      </div>

    </div>

    <div class="telao">
      <div class="display-area">
        <div class="card" id="card">
          <div class="batalhao" id="displayBatalhao">BATALH√ÉO</div>
          <div class="tipo" id="displayTipo">TIPO DE OCORR√äNCIA</div>
          <div class="local" id="displayLocal">LOCAL</div>
        </div>
      </div>
    </div>
  </div>

  <script>
  const senhaCorreta = "Echo2025@"; // üîë defina sua senha aqui

  // Cria uma caixinha b√°sica de senha na tela
  const div = document.createElement("div");
  div.innerHTML = `
    <div style="
      position: fixed;
      inset: 0;
      background: #0b1020;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 10px;
      color: white;
      font-family: Arial;
    ">
      <h2>üîí Acesso Restrito</h2>
      <input id="senhaInput" type="password" placeholder="Digite a senha" 
        style="padding:10px 14px; border-radius:8px; border:none; outline:none; font-size:16px;">
      <button id="btnEntrar" style="margin-top:8px; padding:10px 14px; border:none; border-radius:8px; background:#1f6feb; color:white; cursor:pointer;">Entrar</button>
      <p id="msgErro" style="color:red; display:none;">Senha incorreta!</p>
    </div>
  `;
  document.body.appendChild(div);

  const senhaInput = div.querySelector("#senhaInput");
  const msgErro = div.querySelector("#msgErro");

  div.querySelector("#btnEntrar").addEventListener("click", () => {
    if (senhaInput.value === senhaCorreta) {
      div.remove(); // remove a tela de senha
    } else {
      msgErro.style.display = "block";
      senhaInput.value = "";
      senhaInput.focus();
    }
  });

  senhaInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      div.querySelector("#btnEntrar").click();
    }
  });
</script>



  <script>
    const numBatalhao = document.getElementById('numBatalhao');
    const tipo = document.getElementById('tipo');
    const localEl = document.getElementById('local');
    const card = document.getElementById('card');
    const dispB = document.getElementById('displayBatalhao');
    const dispT = document.getElementById('displayTipo');
    const dispL = document.getElementById('displayLocal');
    const btnUpdate = document.getElementById('btnUpdate');
    const btnClear = document.getElementById('btnClear');
    const siglasBatalhao = document.querySelectorAll('#siglasBatalhao input[type="checkbox"]');

    function getSelectedSiglas() {
    const selected = document.querySelector('#siglasBatalhao input[type="radio"]:checked');
    return selected ? selected.value : '';
    }

    function computeStatus(text){
      if(!text) return 'green';
      const t = text.toLowerCase();
      if(t.includes('acompanh')) return 'red';
      if(t.includes('pinote')) return 'red';
      if(t.includes('baleado')) return 'red';
      if(t.includes('tiro')) return 'red';
      if(t.includes('alvejado')) return 'red';
      if(t.includes('averig')) return 'yellow';
      if(t.includes('andamento')) return 'yellow';
      if(t.includes('encerr')) return 'green';
      return ' ';
    }

    function applyVisual(status){
      card.classList.remove('status-green','status-yellow','status-red','pulse','blink');
      if(status === 'green') card.classList.add('status-green');
      if(status === 'yellow') card.classList.add('status-yellow','pulse');
      if(status === 'red') card.classList.add('status-red','blink');
    }

    async function carregarUltimaOcorrencia() {
    const { data, error } = await supabase
    .from('ocorrencias')
    .select('*')
    .order('id', { ascending: false })
    .limit(1);

    if (data && data.length > 0) {
    const ultima = data[0];
    dispB.textContent = ultima.batalhao.toUpperCase();
    dispT.textContent = ultima.tipo.toUpperCase();
    dispL.textContent = ultima.local.toUpperCase();
    const status = computeStatus(ultima.tipo);
    applyVisual(status);
  }
}


    function updateDisplay(){
      const num = numBatalhao.value.trim() || '00';
      const siglas = getSelectedSiglas() || ' OPM ';
      const t = tipo.value.trim() || ' TESTE QRU ';
      const l = localEl.value.trim() || ' TESTE QTH ';

      dispB.textContent = (num + '¬∫ ' + siglas).toUpperCase();
      dispT.textContent = t.toUpperCase();
      dispL.textContent = l.toUpperCase();

      const status = computeStatus(t);
      applyVisual(status);
    }

    btnUpdate.addEventListener('click', updateDisplay);
    btnUpdate.addEventListener('click', async () => {
  updateDisplay();
  await salvarOcorrencia();

  // üîÅ Garante que o visual (cor) tamb√©m seja atualizado localmente
  const status = computeStatus(tipo.value.trim());
  applyVisual(status);
});


    // Novo bot√£o Resetar
    const btnReset = document.getElementById('reset');

    btnReset.addEventListener('click', async () => {
  // üîπ 1. Limpa os campos no painel
  document.querySelectorAll('input[type="text"]').forEach(inp => inp.value = '');
  document.querySelectorAll('#siglasBatalhao input[type="radio"]').forEach(radio => radio.checked = false);
  localEl.value = '';
  
  // üîπ 2. Atualiza a interface localmente
  dispB.textContent = 'BATALH√ÉO';
  dispT.textContent = 'TIPO DE OCORR√äNCIA';
  dispL.textContent = 'LOCAL';
  card.classList.remove('status-green', 'status-yellow', 'status-red', 'pulse', 'blink');
  card.style.background = 'linear-gradient(180deg,#071026,#0b1226)';
  card.classList.add('flash');
  setTimeout(() => card.classList.remove('flash'), 500);

  try {
    // üîπ 3. Apaga todos os registros da tabela
    const { error: deleteError } = await supabase
      .from('ocorrencias')
      .delete()
      .neq('id', 0); // apaga todos os registros (exceto se quiser preservar algum espec√≠fico)

    if (deleteError) throw deleteError;

    // üîπ 4. Insere o registro padr√£o
    const { error: insertError } = await supabase
      .from('ocorrencias')
      .insert([{
        batalhao: 'BATALH√ÉO',
        tipo: 'TIPO DE OCORR√äNCIA',
        local: 'LOCAL'
      }]);

    if (insertError) throw insertError;

    console.log('üßπ Painel limpo e reiniciado com sucesso!');
  } catch (err) {
    console.error('Erro ao limpar o banco:', err);
  }
});

// Fun√ß√£o com atraso (debounce) para n√£o salvar a cada tecla
let saveTimeout;

function agendarSalvamento() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(async () => {
    updateDisplay();
    await salvarOcorrencia();
  }, 1000); // salva 1s depois da √∫ltima digita√ß√£o
}

// Atualiza e salva automaticamente enquanto digita
[numBatalhao, tipo, localEl].forEach(inp => {
  inp.addEventListener('input', agendarSalvamento);
});

document.querySelectorAll('#siglasBatalhao input[type="radio"]').forEach(radio => {
  radio.addEventListener('change', agendarSalvamento);
});

    updateDisplay();

    async function salvarOcorrencia() {
    const num = numBatalhao.value.trim() || '00';
    const sigla = getSelectedSiglas() || 'OPM';
    const b = num + '¬∫ ' + sigla;  // combina n√∫mero + sigla
    const t = tipo.value.trim();
    const l = localEl.value.trim();

    const { data, error } = await supabase
    .from('ocorrencias')
    .upsert(
      { id: 1, batalhao: b, tipo: t, local: l }, // sempre atualiza o registro de id 1
      { onConflict: 'id' } // importante: define que se o id j√° existir, deve atualizar
    );

    if (error) {
    console.error('Erro ao salvar:', error);
    } else {
    console.log('Ocorr√™ncia salva com sucesso:', data);
    }
  }

    const btnSetaEsq = document.getElementById('btnSetaEsq');
    const btnSetaDir = document.getElementById('btnSetaDir');

  async function mostrarSeta(lado) {
    let texto = dispB.textContent.replace(/‚Üê|‚Üí/g, '').trim(); // remove setas antigas
    let novoTexto = texto;

    if (lado === 'esq') {
    novoTexto = `‚Üê ${texto}`;
    } else if (lado === 'dir') {
    novoTexto = `${texto} ‚Üí`;
    }

    // Atualiza visual localmente
    dispB.textContent = novoTexto;

    // Atualiza no Supabase (para sincronizar com todos)
    try {
    const { error } = await supabase
      .from('ocorrencias')
      .update({ batalhao: novoTexto })
      .eq('id', 1);

    if (error) {
      console.error('Erro ao salvar seta:', error);
    } else {
      console.log('‚úÖ Seta atualizada na nuvem com sucesso!');
    }
    } catch (err) {
    console.error('Erro geral ao atualizar seta:', err);
    }
    }


    // Eventos dos bot√µes
    btnSetaEsq.addEventListener('click', () => mostrarSeta('esq'));
    btnSetaDir.addEventListener('click', () => mostrarSeta('dir'));


  </script>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = 'https://gmzmgwpursikdixqhcoa.supabase.co'; // Substitua pelo seu Project URL
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdtem1nd3B1cnNpa2RpeHFoY29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNjYwOTQsImV4cCI6MjA3Njg0MjA5NH0.STE2QDakuvt2OerbTykdvErdG5uU8vfIlMwP-Wo2z24'; // Substitua pela sua anon public key
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // üî¥ Sincroniza√ß√£o em tempo real
  // üîÅ Escuta mudan√ßas em tempo real no Supabase
supabase
  .channel('publicocorrencias')
  .on(
    'postgres_changes',
    { event: '*', schema: 'public', table: 'ocorrencias' },
    async payload => {
      const nova = payload.new;
      if (!nova) return;

      // Atualiza sempre o DOM com o que veio do Supabase
      dispB.textContent = nova.batalhao?.toUpperCase() || "";
      dispT.textContent = nova.tipo?.toUpperCase() || "";
      dispL.textContent = nova.local?.toUpperCase() || "";

      // Aguarda DOM atualizar antes de aplicar a cor
      await new Promise(r => setTimeout(r, 50));

      // üîπ Recalcula e aplica cor sempre que houver atualiza√ß√£o
      const status = computeStatus(nova.tipo || "");
      applyVisual(status);
    }
  )
  .subscribe();



  carregarUltimaOcorrencia();

</script>

</body>
</html>
